<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>手伝い募集</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>

    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 60vh; width: 100%; }
        select, input {
            width: 90vw;
            height: 35px;
            font-size: 18px;
            margin: 10px;
        }
        button {
            font-size: 16px;
            padding: 6px 10px;
        }
    </style>
</head>

<body>
<div id="map"></div>

<h2>手伝いを呼びかける</h2>

<p>年齢：
<select id="old">
    <option value="">選択してください</option>
    <option value="10代">10代</option>
    <option value="20代">20代</option>
    <option value="30代">30代</option>
    <option value="40代">40代</option>
    <option value="50代">50代</option>
    <option value="60代">60代</option>
    <option value="70代">70代</option>
    <option value="80代">80代</option>
    <option value="90代">90代</option>
    <option value="100代以降">100代以降</option>
</select>
</p>

<p>性別：
<select id="gender">
    <option value="">選択してください</option>
    <option value="男性">男性</option>
    <option value="女性">女性</option>
    <option value="その他">その他</option>
</select>
</p>

<p>タイトル：
<select id="title">
    <option value="">選択してください</option>
    <option value="荷物運び">荷物運び</option>
    <option value="道案内">道案内</option>
    <option value="家の手伝い">家の手伝い</option>
    <option value="ごみ捨て">ごみ捨て</option>
    <option value="その他">その他</option>
</select>
</p>

<p>
<input type="text" id="naiyo" placeholder="募集内容（任意）">
</p>

<button onclick="buttonClick()">募集する</button>

<script>
let map;

// ピンの色
const redIcon = new L.Icon({
    iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
});

const greenIcon = new L.Icon({
    iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
});

document.addEventListener("DOMContentLoaded", () => {
    map = L.map("map").setView([35.7, 139.49], 15);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    navigator.geolocation.getCurrentPosition(pos => {
        map.setView([pos.coords.latitude, pos.coords.longitude], 16);
    });

    loadMarkers();
});

function buttonClick() {
    navigator.geolocation.getCurrentPosition(pos => {
        const data = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            age: document.getElementById("old").value,
            gender: document.getElementById("gender").value,
            title: document.getElementById("title").value,
            naiyo: document.getElementById("naiyo").value
        };

        fetch("/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        }).then(() => {
            alert("募集しました");
            loadMarkers();
        });
    });
}

function loadMarkers() {
    fetch("/list")
        .then(res => res.json())
        .then(data => {

            map.eachLayer(layer => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });

            data.forEach((item, index) => {
                const icon = item.approved ? greenIcon : redIcon;
                const marker = L.marker([item.lat, item.lng], { icon }).addTo(map);

                const button = item.approved
                    ? `<button onclick="complete(${index})">完了</button>`
                    : `<button onclick="approve(${index})">承認する</button>`;

                marker.bindPopup(`
                    <p><b>年齢：</b>${item.age}</p>
                    <p><b>性別：</b>${item.gender}</p>
                    <p><b>タイトル：</b>${item.title}</p>
                    <p><b>内容：</b>${item.naiyo}</p>
                    ${button}
                `);
            });
        });
}

function approve(index) {
    fetch("/approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ index })
    }).then(() => {
        loadMarkers();
    });
}

function complete(index) {
    if (!confirm("この募集を完了して削除しますか？")) return;

    fetch("/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ index })
    }).then(() => {
        loadMarkers();
    });
}
</script>
</body>
</html>

